<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Administrace Pat≈ô√≠me k sobƒõ?</title>
    <meta name="robots" content="noindex, nofollow">
    <style>
    :root {
        --bg-dark: #121212;
        --card-bg: #1e1e1e;
        --text-main: #e0e0e0;
        --text-dim: #b0b0b0;
        --accent: #2196F3;
        --border: #333;
        --input-bg: #2a2a2a;
    }

    body {
        font-family: sans-serif;
        max-width: 900px;
        margin: 20px auto;
        padding: 20px;
        background: var(--bg-dark);
        color: var(--text-main);
    }

    h1, h2 { color: #fff; }

    /* Panel statistik v Dark Modu */
    .stats-banner {
        display: flex;
        gap: 30px;
        background: var(--card-bg);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        border: 1px solid var(--border);
    }
    .stat-box { text-align: center; flex: 1; }
    .stat-value { display: block; font-size: 1.5em; font-weight: bold; color: var(--accent); }
    .stat-label { font-size: 0.8em; color: var(--text-dim); text-transform: uppercase; }

    /* Polo≈æky v seznamu her */
    .game-item {
        background: var(--card-bg);
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .game-item strong, .game-item div { text-transform: uppercase; font-size: 0.85em; }

    /* Tlaƒç√≠tka */
    .btn { padding: 10px 15px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: opacity 0.2s; }
    .btn:hover { opacity: 0.8; }
    .btn-gen { background: #4CAF50; color: white; width: 100%; font-size: 1.1em; margin-bottom: 20px; }
    .btn-del { background: #cf352e; color: white; }
    .btn-save { background: var(--accent); color: white; width: 100%; margin-top: 10px; }

    /* Editor a vstupy */
    #editor {
        background: var(--card-bg);
        padding: 20px;
        border: 2px solid var(--accent);
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }
    .category-edit { margin-bottom: 15px; padding: 10px; border-radius: 5px; }

    input, textarea, select {
        width: 100%;
        margin: 5px 0;
        padding: 8px;
        box-sizing: border-box;
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: #fff;
        font-weight: bold;
    }

    textarea { font-family: monospace; font-size: 13px; resize: vertical; font-weight: normal; color: #aaddff; }

    /* Pastelov√© barvy kategori√≠ (zachov√°ny pro p≈ôehlednost, m√≠rnƒõ utlumeny) */
    .cat-0 { background: #FBD96D; color: #000; } /* ≈Ωlut√° */
    .cat-1 { background: #2e8b57; color: #000; } /* Zelen√° */
    .cat-2 { background: #006994; color: #000; } /* Modr√° */
    .cat-3 { background: #cf352e; color: #fff; } /* Fialov√° */

    .prompt-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    label { font-weight: bold; font-size: 0.9em; color: var(--text-dim); }
</style>
</head>
<body>
    <div id="admin-content">
        <h1>Administrace her</h1>

        <div class="stats-banner">
            <div class="stat-box">
                <span class="stat-label">Dnes hr√°lo</span>
                <span id="stat-views" class="stat-value">0</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Vy≈ôe≈°eno</span>
                <span id="stat-solves" class="stat-value">0</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">√öspƒõ≈°nost</span>
                <span id="stat-rate" class="stat-value">0%</span>
            </div>
        </div>

        <label for="model-select">Vyber AI mozek:</label>
        <select id="model-select" class="control-select">
            <option>Naƒç√≠t√°m dostupn√© modely...</option>
        </select>

        <div class="prompt-container">
            <div>
                <label for="prompt-input">1. Tv≈Ørce (Generator):</label>
                <textarea id="prompt-input" style="height: 300px;">
                  Jsi zku≈°en√Ω tv≈Ørce ƒçesk√Ωch slovn√≠ch her a hlavolam≈Ø na √∫rovni redaktora New York Times.
                  V√ù≈†E m√°≈° uveden√© p≈ô√≠klady √∫spƒõ≈°n√Ωch her. Tv√Ωm hlavn√≠m c√≠lem je:
                  1. ZACHOVAT stejnou √∫rove≈à vtipu, logiky a kvality jako v p≈ô√≠kladech.
                  2. ZCELA SE VYHNOUT t√©mat≈Øm a slov≈Øm, kter√° se v p≈ô√≠kladech objevuj√≠ (nechceme duplicity).
                  Perfektnƒõ ovl√°d√°≈° ƒçesk√Ω jazyk, jeho v√Ωznamov√© odst√≠ny, homonyma, fraz√©my a ƒçesk√Ω kulturn√≠ kontext (historie, mƒõsta, re√°lie).

                  Tv√Ωm √∫kolem je vytvo≈ôit jednu hru ‚ÄûPat≈ô√≠me k sobƒõ?‚Äú (styl NYT Connections).Vra≈• POUZE ƒçist√Ω JSON objekt.

                  Struktura JSON:
                  {
                    "categories": [
                      {"name": "N√ÅZEV KAT 1 (≈Ωlut√° - nejlehƒç√≠)", "words": ["W1", "W2", "W3", "W4"], "color": 0},
                      {"name": "N√ÅZEV KAT 2 (Zelen√° - st≈ôedn√≠)", "words": ["W1", "W2", "W3", "W4"], "color": 1},
                      {"name": "N√ÅZEV KAT 3 (Modr√° - tƒõ≈æk√°)", "words": ["W1", "W2", "W3", "W4"], "color": 2},
                      {"name": "N√ÅZEV KAT 4 (Fialov√° - nejtƒõ≈æ≈°√≠, slovn√≠ h≈ô√≠ƒçka)", "words": ["W1", "W2", "W3", "W4"], "color": 3}
                    ]
                  }

                  Pravidla pro tvorbu hry:
                  SLOVA
                  Pou≈æij p≈ôesnƒõ 16 unik√°tn√≠ch ƒçesk√Ωch slov.
                  Slova maj√≠ b√Ωt p≈ôev√°≈ænƒõ podstatn√° jm√©na, VELK√ùM P√çSMEM, v 1. p√°dƒõ jednotn√©ho ƒç√≠sla.
                  V√Ωjimky (mno≈æn√© ƒç√≠slo nebo vlastn√≠ jm√©na) jsou povoleny pouze tehdy, pokud jsou nezbytn√© pro danou kategorii.
                  Lze pou≈æ√≠t i ostatn√≠ slovn√≠ druhy.

                  Z√ÅKAZ TRIVI√ÅLNOSTI
                  Nepou≈æ√≠vej barvy, ovoce, dny v t√Ωdnu ani z√°kladn√≠ ≈°koln√≠ kategorie.
                  Vyh√Ωbej se p≈ô√≠li≈° obecn√Ωm t≈ô√≠d√°m (nap≈ô. ‚Äûzv√≠≈ôata‚Äú, ‚Äûn√°bytek‚Äú).
                  C√≠lem je originalita a chytr√Ω n√°pad.

                  FALE≈†N√â STOPY (RED HERRINGS)
                  Alespo≈à dvƒõ slova mus√≠ na prvn√≠ pohled sv√°dƒõt k jin√© kategorii ne≈æ t√© spr√°vn√©.
                  Tyto fale≈°n√© stopy nesm√≠ umo≈ænit vznik alternativn√≠ kompletn√≠ ƒçtve≈ôice.

                  KATEGORIE A OBT√ç≈ΩNOST
                  ≈Ωlut√° (yellow): P≈ô√≠m√Ω, zjevn√Ω v√Ωznam nebo bƒõ≈æn√° kategorie.
                  Zelen√° (green): Specifiƒçtƒõj≈°√≠ kontext nebo znalost (nap≈ô. oblasti, typy, role).
                  Modr√° (blue): Abstraktnƒõj≈°√≠ spojen√≠, ƒçesk√© re√°lie nebo kulturn√≠ znalosti.
                  Fialov√° (purple): Jedna jasn√° jazykov√° h≈ô√≠ƒçka zalo≈æen√° na jedin√©m principu
                  (nap≈ô. spoleƒçn√° p≈ôedpona, p≈ô√≠pona, skryt√© slovo, fonetick√° shoda, zkratka).
                  Nekombinuj v√≠ce princip≈Ø v jedn√© fialov√© kategorii.

                  F√âROVOST
                  Ka≈æd√© slovo mus√≠ po logick√©m vylouƒçen√≠ pat≈ôit pr√°vƒõ do jedn√© kategorie.
                  Hra mus√≠ m√≠t pr√°vƒõ jedno jednoznaƒçn√© ≈ôe≈°en√≠.

                  JAZYK A KONTEXT
                  Pou≈æ√≠vej v√Ωhradnƒõ ƒçe≈°tinu.
                  Nepou≈æ√≠vej anglicismy ani ciz√≠ v√Ωrazy.
                  Preferuj slova s v√≠ce v√Ωznamy nebo kulturn√≠m p≈ôesahem v ƒçesk√©m prost≈ôed√≠.
                  </textarea>
            </div>
            <div>
                <label for="critic-prompt-input">2. Kritik (Critic):</label>
                <textarea id="critic-prompt-input" style="height: 300px;">
                  Jsi elitn√≠ editor New York Times specializovan√Ω na logick√© hry. Tv√Ωm √∫kolem je posoudit, zda m√° p≈ôedlo≈æen√° hra "Pat≈ô√≠me k sobƒõ?" pr√°vƒõ JEDNO unik√°tn√≠ ≈ôe≈°en√≠ pro v≈°ech 16 slov.

                  Vstupn√≠ JSON: {game_json}

                  TV≈ÆJ ANALYTICK√ù PROCES (Simulace hr√°ƒçe):
                  1. POVINN√â FALE≈†N√â STOPY: Identifikuj slova s v√≠ce v√Ωznamy (homonyma). Fale≈°n√© stopy jsou ≈Ω√ÅDOUC√ç a zvy≈°uj√≠ kvalitu hry.
                  2. TEST "SLEP√â ULIƒåKY": Pokud slovo X (nap≈ô. KORUNA) pasuje do Kategorie A (Stromy) i Kategorie B (Pen√≠ze), zkus ho ment√°lnƒõ za≈ôadit do Kategorie A.
                     - Zbylo v Kategorii B st√°le dost slov (4), aby vytvo≈ôila logickou skupinu?
                     - Pokud NE (zbyly jen 3 pojmy a ≈æ√°dn√Ω jin√Ω z cel√Ωch 16 se tam nehod√≠), je to SKVƒöL√Å FALE≈†N√Å STOPA. Hr√°ƒç naraz√≠ na slepou uliƒçku a mus√≠ se vr√°tit. (Stav: PASS)
                  3. TEST "ROZBIT√â HRY": Pokud lze slova X a Y mezi kategoriemi libovolnƒõ prohodit a obƒõ verze d√°vaj√≠ 4 perfektn√≠ ƒçtve≈ôice, hra je ROZBIT√Å. (Stav: FAIL)
                  4. JAZYKOV√Å KVALITA: Fialov√° kategorie mus√≠ m√≠t "Aha! moment". Modr√° nesm√≠ b√Ωt p≈ô√≠li≈° v√°gn√≠ (nap≈ô. "Vƒõci na S" je slab√©, "Slova zaƒç√≠naj√≠c√≠ na chemickou znaƒçku" je dobr√©).

                  V√ùSTUPN√ç FORM√ÅT (P≈ò√çSNƒö DODR≈ΩET):
                  Pokud hra projde testem unik√°tnosti (i p≈ôes siln√© fale≈°n√© stopy):
                  { "verdict": "PASS" }

                  Pokud hra sel≈æe (existuje alternativn√≠ rozdƒõlen√≠ v≈°ech 16 slov nebo je kategorie nesmysln√°):
                  {
                    "verdict": "FAIL",
                    "issues": [
                      {
                        "type": "ALTERNATIVE_SOLUTION | WEAK_LOGIC | INVALID_PURPLE",
                        "description": "Popi≈°, proƒç hra nefunguje (nap≈ô. 'Pokud d√°m KORUNA ke strom≈Øm, v penƒõz√≠ch mi zbude GRO≈†, TOLAR a DUK√ÅT, ale jako ƒçtvrt√© slovo tam pasuje i B≈ò√çZA ze strom≈Ø, co≈æ vytv√°≈ô√≠ 2 ≈ôe≈°en√≠')",
                        "example": "Slovo/Kombinace, kter√° to rozb√≠j√≠"
                      }
                    ]
                  }</textarea>
            </div>
        </div>

        <button class="btn btn-gen" onclick="generateNewGame(event)">‚ú® Dvouf√°zov√© generov√°n√≠ (Tv≈Ørce + Kritik)</button>

        <div id="editor">
            <h2 id="editor-title">Upravit vygenerovanou hru</h2>
            <div id="editor-fields"></div>
            <button class="btn btn-save" onclick="saveGame()">üíæ Ulo≈æit hru do datab√°ze</button>
        </div>

        <h2>Seznam her v datab√°zi</h2>
        <div id="games-list">Naƒç√≠t√°m seznam...</div>
    </div>

    <script>
        const API_BASE = "https://vladimir371.pythonanywhere.com/api";
        const STATS_URL = "https://vladimir371.pythonanywhere.com/api";
        let adminPassword = localStorage.getItem('admin_password');

        if (!adminPassword) {
            adminPassword = prompt("Zadejte administr√°torsk√© heslo:");
            localStorage.setItem('admin_password', adminPassword);
        }

        async function initializeAdmin() {
            const res = await fetch(`${API_BASE}/list`, {
                headers: { 'X-Admin-Password': adminPassword }
            });

            if (res.ok) {
                document.getElementById('admin-content').style.display = 'block';
                loadGames();
                loadAvailableModels();
                loadStats();
            } else {
                alert("Chybn√© heslo.");
                localStorage.removeItem('admin_password');
                location.reload();
            }
        }

        async function adminFetch(url, options = {}) {
            if (!options.headers) options.headers = {};
            options.headers['X-Admin-Password'] = adminPassword;
            options.headers['Content-Type'] = 'application/json';
            try {
                const response = await fetch(url, options);
                if (response.status === 401) {
                    localStorage.removeItem('admin_password');
                    location.reload();
                    return null;
                }
                return response;
            } catch (err) {
                console.error("Chyba spojen√≠:", err);
                throw err;
            }
        }

        async function loadStats() {
            try {
                const res = await fetch(STATS_URL);
                const data = await res.json();
                document.getElementById('stat-views').innerText = data.views;
                document.getElementById('stat-solves').innerText = data.solves;
                const rate = data.views > 0 ? Math.round((data.solves / data.views) * 100) : 0;
                document.getElementById('stat-rate').innerText = rate + "%";
            } catch (e) { console.error("Statistiky ne≈°lo naƒç√≠st"); }
        }

        async function loadAvailableModels() {
            const select = document.getElementById('model-select');
            try {
                const response = await adminFetch(`${API_BASE}/available-models`);
                const models = await response.json();
                select.innerHTML = '';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.text = model.display_name;
                    if (model.id.includes('2.0-flash')) option.selected = true;
                    select.appendChild(option);
                });
            } catch (error) { select.innerHTML = '<option>Chyba naƒç√≠t√°n√≠ model≈Ø</option>'; }
        }

        async function generateNewGame(event) {
            const btn = event.target;
            const originalText = btn.innerText;
            const model = document.getElementById('model-select').value;
            const prompt = document.getElementById('prompt-input').value;
            const critic_prompt = document.getElementById('critic-prompt-input').value;

            btn.innerText = "‚è≥ Prob√≠h√° anal√Ωza kritikem...";
            btn.disabled = true;

            try {
                const res = await adminFetch(`${API_BASE}/generate`, {
                    method: 'POST',
                    body: JSON.stringify({ model, prompt, critic_prompt })
                });

                const result = await res.json();

                if (result.status === "rejected") {
                    // Sestaven√≠ detailn√≠ho seznamu chyb z pole all_issues
                    let errorDetails = "";
                    if (result.all_issues && Array.isArray(result.all_issues)) {
                        errorDetails = result.all_issues.map(iss =>
                            `‚Ä¢ [${iss.type}]: ${iss.description}${iss.example ? ' (Nap≈ô: ' + iss.example + ')' : ''}`
                        ).join('\n');
                    } else {
                        errorDetails = result.message;
                    }

                    alert("‚ùå KRITIK HRU ODM√çTL:\n\n" + errorDetails);

                    document.getElementById('editor-title').innerText = "‚ö†Ô∏è Odm√≠tnut√Ω n√°vrh (vy≈æaduje opravu)";
                    displayGeneratedGame(result.data);

                } else if (result.status === "approved") {
                    alert("‚úÖ KRITIK HRU SCHV√ÅLIL!");
                    document.getElementById('editor-title').innerText = "‚ú® Schv√°len√Ω n√°vrh p≈ôipraven k ulo≈æen√≠";
                    displayGeneratedGame(result.data);

                } else if (result.error) {
                    alert("Chyba AI: " + result.error);
                }
            } catch (e) {
                alert("Generov√°n√≠ selhalo: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function displayGeneratedGame(gameData) {
            const editor = document.getElementById('editor');
            const fields = document.getElementById('editor-fields');
            editor.style.display = 'block';
            fields.innerHTML = '';

            if (!gameData.categories) return;

            gameData.categories.forEach((cat, i) => {
                const div = document.createElement('div');
                div.className = `category-edit cat-${i}`;
                div.innerHTML = `
                    <input type="text" id="cat-name-${i}" value="${cat.name}" placeholder="N√°zev kategorie">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px;">
                        <input type="text" id="cat-w-${i}-0" value="${cat.words[0]}">
                        <input type="text" id="cat-w-${i}-1" value="${cat.words[1]}">
                        <input type="text" id="cat-w-${i}-2" value="${cat.words[2]}">
                        <input type="text" id="cat-w-${i}-3" value="${cat.words[3]}">
                    </div>
                `;
                fields.appendChild(div);
            });
            editor.scrollIntoView({ behavior: 'smooth' });
        }

        async function saveGame() {
            const categories = [];
            for(let i=0; i<4; i++) {
                categories.push({
                    name: document.getElementById(`cat-name-${i}`).value,
                    words: [
                        document.getElementById(`cat-w-${i}-0`).value,
                        document.getElementById(`cat-w-${i}-1`).value,
                        document.getElementById(`cat-w-${i}-2`).value,
                        document.getElementById(`cat-w-${i}-3`).value
                    ],
                    color: i
                });
            }

            const res = await adminFetch(`${API_BASE}/save`, {
                method: 'POST',
                body: JSON.stringify({ categories })
            });

            if (res && res.ok) {
                alert("Ulo≈æeno!");
                document.getElementById('editor').style.display = 'none';
                loadGames();
            }
        }

        async function loadGames() {
            const res = await adminFetch(`${API_BASE}/list`);
            if (!res) return;
            const games = await res.json();
            const listDiv = document.getElementById('games-list');
            listDiv.innerHTML = '';

            games.forEach(game => {
                const div = document.createElement('div');
                div.className = 'game-item';

                // Upraven√Ω v√Ωpoƒçet v loadGames
                const views = parseInt(game.final_views) || 0;
                const solves = parseInt(game.final_solves) || 0;
                const rate = views > 0 ? Math.round((solves / views) * 100) : 0;

                // Vylep≈°en√Ω HTML ≈ô√°dek statistik
                let statsHtml = `
                    <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; font-size: 0.85em; color: var(--text-dim); display: flex; gap: 15px;">
                        <span>üìä <strong>${views}</strong> hr√°ƒç≈Ø</span>
                        <span>‚úÖ <strong>${solves}</strong> vy≈ôe≈°eno</span>
                        <span style="color: ${rate > 50 ? '#4CAF50' : '#ff9800'}">üìà √öspƒõ≈°nost: <strong>${rate}%</strong></span>
                    </div>
                `;

                let statusInfo = game.used
                    ? `<span style="color: #4CAF50; font-weight: bold;">‚úÖ Publikov√°no: ${game.date_published}</span>`
                    : `<span style="color: #999;">üïí V po≈ôad√≠ (ƒçek√°)</span>`;

                let categoriesHtml = game.categories.map((cat, i) => `
                    <div style="margin-top: 5px; padding: 5px; border-radius: 4px; font-size: 0.8em;" class="cat-${i}">
                        <strong>${cat.name}:</strong> ${cat.words.join(', ')}
                    </div>
                `).join('');

                div.innerHTML = `
                    <div style="flex-grow: 1;">
                        <div style="margin-bottom: 4px; font-size: 0.9em;">
                            <strong>Hra #${game.id}</strong> | ${statusInfo}
                        </div>
                        ${game.used ? statsHtml : ''}
                        <div style="margin-top: 10px;">
                            ${categoriesHtml}
                        </div>
                    </div>
                    <button class="btn btn-del" onclick="deleteGame(${game.id})" style="align-self: flex-start; margin-left: 15px;">Smazat</button>
                `;
                listDiv.appendChild(div);
            });
        }

        async function deleteGame(id) {
            if (!confirm("Opravdu smazat?")) return;
            await adminFetch(`${API_BASE}/delete`, {
                method: 'POST',
                body: JSON.stringify({ id })
            });
            loadGames();
        }

        initializeAdmin();
    </script>
</body>
</html>




